问题
====

:arrow_forward:新上线一个功能如何设计切流方案？

:arrow_forward:旧系统拆分出多个新系统时，如何设计切流方案？

新上线一个功能如何设计切流方案？
====

新功能上线的过程中，在我所处的发布环境中会经历这么几个阶段，首先推上预发环境->灰度环境->生产环境。其中灰度环境和生产环境都是**beta发布过程**。

beta发布过程且未切流之前
------

既然是**beta发布过程就会存在旧代码和新代码功能运行的现象**。针对这种现象，我们需要在一开始设计新功能点的时候，就应该将新功能对原有系统的影响点评估到位，考虑兼容性，通过切流开关或代码层面设计来做到新功能上线后，在没有切流前做到新老代码共存，但是整个业务语意表象依旧是新功能没上线前的业务语意。

白名单验证
------

需要考虑的切流步骤一般验证如下步骤进行，**每一步均在新功能设计之后反复交叉考虑是否想到了此种情况下的兼容性**。才可以做到新功能点上线后，不会存在不兼容和切流后部分数据验证出现线上问题的情况。

1）验证beta发布完成之后，此时机器上均为新代码（即包含新功能点的系统），观察业务语意是否和未发布之前保持一致。（此处可能存在特殊重要业务场景验证不到位的情况，所以才有了第二步）

2）验证新功能之前要做的第一件事情，即使用存量用户数据验证已有功能是否依旧和未发布新功能点之前保持一致。（针对特殊且重要业务需要推送存量用户数据做验证，若不存在此种情况，可以直接跳到下一步）

3）推送单个白名单存量数据，验证存量数据在新代码下运行已有业务链路是否符合已有业务语意。

4）推送单个白名单存量数据，验证存量数据在新代码下运行新业务链路是否符合预期业务语意。

5）推送单个白名单新用户数据，验证新数据在新代码下运行已有和新业务业务链路是否符合业务语意。

以上未白名单验证过程。是一个不可以跳过的阶段。否则很容易影响较多用户。:smirk::smirk::smirk::smirk:一般如果跳过这一步直接到下一步百分比验证出现了问题，都会追责，正常情况下都是会影响绩效的，所以要重视起来。

百分比切流验证
------






